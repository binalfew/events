generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────

enum UserStatus {
  ACTIVE
  INACTIVE
  LOCKED
  SUSPENDED
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELED
  COMPLETED
  POSTPONED
  RESCHEDULED
}

enum FieldDataType {
  TEXT
  LONG_TEXT
  NUMBER
  BOOLEAN
  DATE
  DATETIME
  ENUM
  MULTI_ENUM
  EMAIL
  URL
  PHONE
  FILE
  IMAGE
  REFERENCE
  FORMULA
  JSON
}

enum RequestStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  CANCELLED
  PRINTED
}

enum WorkflowStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum StepType {
  REVIEW
  APPROVAL
  PRINT
  COLLECT
  NOTIFICATION
  CUSTOM
  FORK
  JOIN
}

enum AssignmentStrategy {
  MANUAL
  ROUND_ROBIN
  LEAST_LOADED
}

enum AutoActionType {
  AUTO_APPROVE
  AUTO_REJECT
  AUTO_BYPASS
  AUTO_ESCALATE
}

enum DelegationInviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum ViewType {
  TABLE
  KANBAN
  CALENDAR
  GALLERY
}

enum StepAction {
  APPROVE
  REJECT
  BYPASS
  RETURN
  ESCALATE
}

enum SLAAction {
  NOTIFY
  ESCALATE
  AUTO_APPROVE
  AUTO_REJECT
  REASSIGN
}

enum ApprovalAction {
  APPROVE
  REJECT
  BYPASS
  RETURN
  ESCALATE
  PRINT
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  APPROVE
  REJECT
  PRINT
  COLLECT
  EXPORT
  IMPORT
  CONFIGURE
  ASSIGN
  SLA_BREACH
  RATE_LIMIT
  FILE_UPLOAD
  FILE_UPLOAD_BLOCKED
}

enum ApiKeyStatus {
  ACTIVE
  ROTATED
  REVOKED
  EXPIRED
}

enum RateLimitTier {
  STANDARD
  ELEVATED
  PREMIUM
  CUSTOM
}

enum WebhookStatus {
  ACTIVE
  PAUSED
  DISABLED
  SUSPENDED
}

enum DeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  RETRYING
  DEAD_LETTER
}

enum ScanType {
  QR_SCAN
  NFC_TAP
  MANUAL_ENTRY
}

enum ScanResult {
  VALID
  INVALID
  EXPIRED
  REVOKED
  ALREADY_SCANNED
  MANUAL_OVERRIDE
}

enum BulkOperationType {
  IMPORT_PARTICIPANTS
  EXPORT_PARTICIPANTS
  STATUS_CHANGE
  BULK_APPROVE
  BULK_REJECT
  BULK_BYPASS
  FIELD_UPDATE
  DELETE
}

enum BulkOperationStatus {
  VALIDATING
  PREVIEW
  CONFIRMED
  PROCESSING
  COMPLETED
  FAILED
  ROLLED_BACK
}

enum DuplicateStatus {
  PENDING_REVIEW
  CONFIRMED_DUPLICATE
  NOT_DUPLICATE
  MERGED
}

enum WaitlistStatus {
  ACTIVE
  PROMOTED
  EXPIRED
  WITHDRAWN
  CANCELLED
}

enum WaitlistPriority {
  STANDARD
  HIGH
  VIP
}

enum MessageChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum MessageStatus {
  QUEUED
  SENDING
  SENT
  DELIVERED
  BOUNCED
  FAILED
}

enum BroadcastStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  CANCELLED
}

enum CloneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  ROLLED_BACK
}

enum QueueStatus {
  WAITING
  CALLED
  SERVING
  COMPLETED
  CANCELLED
}

// ─── Phase 5 Enums ──────────────────────────────────────

// Accommodation
enum RoomBlockStatus {
  AVAILABLE
  RESERVED
  OCCUPIED
  RELEASED
}

enum AccommodationAssignmentStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
}

// Transport
enum TransferType {
  AIRPORT_ARRIVAL
  AIRPORT_DEPARTURE
  INTER_VENUE
  CUSTOM
}

enum VehicleType {
  SEDAN
  SUV
  VAN
  BUS
  MINIBUS
}

enum TransferStatus {
  SCHEDULED
  EN_ROUTE
  COMPLETED
  CANCELLED
  NO_SHOW
}

// Catering
enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  RECEPTION
  COFFEE_BREAK
  SNACK
}

enum DietaryCategory {
  REGULAR
  VEGETARIAN
  VEGAN
  HALAL
  KOSHER
  GLUTEN_FREE
  CUSTOM
}

// Parking
enum ParkingPermitStatus {
  ACTIVE
  EXPIRED
  REVOKED
  SUSPENDED
}

// Venue
enum RoomBookingStatus {
  TENTATIVE
  CONFIRMED
  CANCELLED
}

// Protocol
enum SeatingPriority {
  HEAD_OF_STATE
  MINISTER
  AMBASSADOR
  SENIOR_OFFICIAL
  DELEGATE
  OBSERVER
  MEDIA
}

enum BilateralStatus {
  REQUESTED
  CONFIRMED
  DECLINED
  CANCELLED
  COMPLETED
}

// Companion
enum CompanionType {
  SPOUSE
  FAMILY
  AIDE
  SECURITY
  INTERPRETER
}

// Gift
enum GiftDeliveryStatus {
  PENDING
  ASSEMBLED
  DELIVERED
  RETURNED
}

// Incident
enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  REPORTED
  INVESTIGATING
  ESCALATED
  RESOLVED
  CLOSED
}

// Staff
enum ShiftStatus {
  SCHEDULED
  CHECKED_IN
  ACTIVE
  CHECKED_OUT
  NO_SHOW
}

enum StaffRole {
  COORDINATOR
  USHER
  SECURITY
  PROTOCOL
  TECHNICAL
  MEDICAL
  TRANSPORT
  CATERING
}

// Compliance
enum ComplianceStatus {
  VALID
  EXPIRING_SOON
  EXPIRED
  NOT_PROVIDED
}

enum DataRetentionAction {
  RETAIN
  ANONYMIZE
  DELETE
}

// Survey
enum SurveyStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

// Certificate
enum CertificateStatus {
  DRAFT
  GENERATED
  SENT
  DOWNLOADED
  REVOKED
}

// ─── Identity & Access Domain ────────────────────────────

model Tenant {
  id               String   @id @default(cuid())
  name             String   @unique
  email            String   @unique
  phone            String
  website          String?
  address          String?
  city             String?
  state            String?
  zip              String?
  country          String?
  billingInfo      Json?
  subscriptionPlan String
  featureFlags     Json?
  usageMetrics     Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  users            User[]
  events           Event[]
  roles            Role[]
  participantTypes ParticipantType[]
  workflows        Workflow[]
  participants     Participant[]
  fieldDefinitions FieldDefinition[]
  formTemplates    FormTemplate[]
  sectionTemplates SectionTemplate[]
  notifications    Notification[]

  // Phase 4 reverse relations
  apiKeys              ApiKey[]
  webhookSubscriptions WebhookSubscription[]
  messageTemplates     MessageTemplate[]
  broadcastMessages    BroadcastMessage[]
  eventSeries          EventSeries[]

  // Phase 5 reverse relations
  hotels                   Hotel[]
  accommodationAssignments AccommodationAssignment[]
  transportRoutes          TransportRoute[]
  vehicles                 Vehicle[]
  transfers                Transfer[]
  mealPlans                MealPlan[]
  parkingZones             ParkingZone[]
  parkingPermits           ParkingPermit[]
  venueMaps                VenueMap[]
  roomBookings             RoomBooking[]
  seatingPlans             SeatingPlan[]
  bilateralMeetings        BilateralMeeting[]
  meetingSlots             MeetingSlot[]
  companions               Companion[]
  companionActivities      CompanionActivity[]
  giftItems                GiftItem[]
  welcomePackages          WelcomePackage[]
  giftDeliveries           GiftDelivery[]
  incidents                Incident[]
  commandCenterWidgets     CommandCenterWidget[]
  alertRules               AlertRule[]
  staffMembers             StaffMember[]
  staffShifts              StaffShift[]
  surveys                  Survey[]
  certificateTemplates     CertificateTemplate[]
  certificates             Certificate[]
  documentRequirements     DocumentRequirement[]
  participantDocuments     ParticipantDocument[]
  dataRetentionPolicies    DataRetentionPolicy[]

  @@index([name, email])
}

model User {
  id                  String     @id @default(cuid())
  email               String     @unique
  username            String     @unique
  name                String?
  status              UserStatus @default(ACTIVE)
  failedLoginAttempts Int        @default(0)
  lastFailedLoginAt   DateTime?
  lockedAt            DateTime?
  lockReason          String?
  lockCount           Int        @default(0)
  autoUnlockAt        DateTime?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  deletedAt           DateTime?

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  password        Password?
  sessions        Session[]
  userRoles       UserRole[]
  approvals       Approval[]
  notifications   Notification[]
  stepAssignments StepAssignment[] @relation("StepAssignments")
  savedViews      SavedView[]      @relation("SavedViews")

  // Phase 5 named reverse relations
  roomBookings                RoomBooking[]         @relation("RoomBookingBookedBy")
  seatingAssignments          SeatingAssignment[]   @relation("SeatingAssignedBy")
  bilateralRequests           BilateralMeeting[]    @relation("BilateralRequestedBy")
  incidentsReported           Incident[]            @relation("IncidentReportedBy")
  incidentsAssigned           Incident[]            @relation("IncidentAssignedTo")
  incidentsResolved           Incident[]            @relation("IncidentResolvedBy")
  incidentUpdates             IncidentUpdate[]      @relation("IncidentUpdateBy")
  escalationsReceived         IncidentEscalation[]  @relation("EscalatedTo")
  escalationsInitiated        IncidentEscalation[]  @relation("EscalatedBy")
  seatingConflictsResolved    SeatingConflict[]     @relation("SeatingConflictResolvedBy")
  shiftAssignmentsMade        ShiftAssignment[]     @relation("ShiftAssignedBy")
  giftDeliveriesMade          GiftDelivery[]        @relation("GiftDeliveredBy")
  participantDocVerifications ParticipantDocument[] @relation("DocumentVerifiedBy")
  staffMembers                StaffMember[]

  @@index([deletedAt])
  @@index([tenantId])
}

model Password {
  hash   String
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Session {
  id             String   @id @default(cuid())
  expirationDate DateTime
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId, expirationDate])
}

// ─── Event Management Domain ─────────────────────────────

model Event {
  id          String      @id @default(cuid())
  name        String
  description String
  tenantId    String
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  status      EventStatus @default(DRAFT)
  startDate   DateTime
  endDate     DateTime
  extras      Json        @default("{}")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?

  participantTypes ParticipantType[]
  participants     Participant[]
  workflows        Workflow[]
  fieldDefinitions FieldDefinition[]
  formTemplates    FormTemplate[]
  userRoles        UserRole[]
  delegationQuotas DelegationQuota[]

  // Phase 4 reverse relations
  checkpoints       Checkpoint[]
  venueOccupancies  VenueOccupancy[]
  kioskDevices      KioskDevice[]
  queueTickets      QueueTicket[]
  bulkOperations    BulkOperation[]
  waitlistEntries   WaitlistEntry[]
  broadcastMessages BroadcastMessage[]
  eventEdition      EventEdition?

  // Phase 5 reverse relations
  hotels                   Hotel[]
  accommodationAssignments AccommodationAssignment[]
  transportRoutes          TransportRoute[]
  vehicles                 Vehicle[]
  transfers                Transfer[]
  mealPlans                MealPlan[]
  parkingZones             ParkingZone[]
  parkingPermits           ParkingPermit[]
  venueMaps                VenueMap[]
  roomBookings             RoomBooking[]
  seatingPlans             SeatingPlan[]
  bilateralMeetings        BilateralMeeting[]
  meetingSlots             MeetingSlot[]
  companions               Companion[]
  companionActivities      CompanionActivity[]
  giftItems                GiftItem[]
  welcomePackages          WelcomePackage[]
  giftDeliveries           GiftDelivery[]
  incidents                Incident[]
  commandCenterWidgets     CommandCenterWidget[]
  alertRules               AlertRule[]
  staffMembers             StaffMember[]
  staffShifts              StaffShift[]
  surveys                  Survey[]
  certificateTemplates     CertificateTemplate[]
  certificates             Certificate[]
  documentRequirements     DocumentRequirement[]

  @@unique([tenantId, name])
  @@index([tenantId, status])
  @@index([deletedAt])
}

// ─── RBAC Domain ────────────────────────────────────────

model Role {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Permission {
  id          String   @id @default(cuid())
  resource    String
  action      String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]

  @@unique([resource, action])
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  eventId   String?
  event     Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, roleId, eventId])
  @@index([userId])
  @@index([roleId])
  @@index([eventId])
}

// ─── Participant & Workflow Domain ──────────────────────

model ParticipantType {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name        String
  code        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  participants     Participant[]
  fieldDefinitions FieldDefinition[]
  formTemplates    FormTemplate[]

  @@unique([tenantId, eventId, code])
  @@index([tenantId, eventId])
}

model Workflow {
  id          String         @id @default(cuid())
  tenantId    String
  tenant      Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId     String
  event       Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name        String
  description String?
  status      WorkflowStatus @default(DRAFT)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?

  steps        Step[]
  versions     WorkflowVersion[]
  participants Participant[]

  @@unique([tenantId, eventId, name])
  @@index([tenantId])
  @@index([eventId])
  @@index([deletedAt])
}

model Step {
  id                 String     @id @default(cuid())
  workflowId         String
  workflow           Workflow   @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  name               String
  description        String?
  order              Int
  stepType           StepType   @default(REVIEW)
  isEntryPoint       Boolean    @default(false)
  isTerminal         Boolean    @default(false)
  // Soft references (string IDs) for flexible routing
  nextStepId         String?
  rejectionTargetId  String?
  bypassTargetId     String?
  escalationTargetId String?
  // SLA configuration
  slaDurationMinutes Int?
  slaAction          SLAAction?
  config             Json       @default("{}")
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  approvals       Approval[]
  assignments     StepAssignment[]
  autoActionRules AutoActionRule[]

  // Phase 4 reverse relations
  parallelBranches ParallelBranch[]

  @@unique([workflowId, order])
  @@index([workflowId])
}

model WorkflowVersion {
  id                String   @id @default(cuid())
  workflowId        String
  workflow          Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  version           Int
  snapshot          Json
  changeDescription String?
  createdBy         String
  createdAt         DateTime @default(now())

  participants Participant[]

  @@unique([workflowId, version])
  @@index([workflowId])
}

model Participant {
  id                String           @id @default(cuid())
  tenantId          String
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId           String
  event             Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participantTypeId String
  participantType   ParticipantType  @relation(fields: [participantTypeId], references: [id])
  workflowId        String
  workflow          Workflow         @relation(fields: [workflowId], references: [id])
  workflowVersionId String?
  workflowVersion   WorkflowVersion? @relation(fields: [workflowVersionId], references: [id])
  currentStepId     String?
  // Fixed identity fields
  registrationCode  String
  firstName         String
  lastName          String
  email             String?
  organization      String?
  jobTitle          String?
  nationality       String?
  status            RequestStatus    @default(PENDING)
  // Dynamic fields
  extras            Json             @default("{}")
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  deletedAt         DateTime?

  approvals Approval[]

  // Phase 4 reverse relations
  accessLogs        AccessLog[]
  queueTickets      QueueTicket[]
  waitlistEntry     WaitlistEntry?
  messageDeliveries MessageDelivery[]
  parallelBranches  ParallelBranch[]

  // Phase 5 reverse relations
  accommodationAssignment AccommodationAssignment?
  transferPassengers      TransferPassenger[]
  mealVouchers            MealVoucher[]
  parkingPermits          ParkingPermit[]
  seatingAssignments      SeatingAssignment[]
  bilateralRequests       BilateralMeeting[]       @relation("BilateralRequester")
  bilateralInvitations    BilateralMeeting[]       @relation("BilateralRequestee")
  companions              Companion[]
  giftDeliveries          GiftDelivery[]
  surveyResponses         SurveyResponse[]
  certificates            Certificate[]
  participantDocuments    ParticipantDocument[]

  @@unique([tenantId, eventId, registrationCode])
  @@index([tenantId, eventId])
  @@index([eventId, status])
  @@index([participantTypeId])
  @@index([workflowId])
  @@index([workflowVersionId])
  @@index([currentStepId])
  @@index([deletedAt])
}

model Approval {
  id            String         @id @default(cuid())
  participantId String
  participant   Participant    @relation(fields: [participantId], references: [id], onDelete: Cascade)
  stepId        String
  step          Step           @relation(fields: [stepId], references: [id])
  userId        String
  user          User           @relation(fields: [userId], references: [id])
  action        ApprovalAction
  remarks       String?
  metadata      Json?
  createdAt     DateTime       @default(now())

  @@index([participantId, stepId])
  @@index([stepId, userId])
  @@index([userId, createdAt])
}

model FieldDefinition {
  id                String           @id @default(cuid())
  tenantId          String
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId           String
  event             Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participantTypeId String?
  participantType   ParticipantType? @relation(fields: [participantTypeId], references: [id])
  entityType        String           @default("Participant")
  name              String
  label             String
  description       String?
  dataType          FieldDataType
  sortOrder         Int              @default(0)
  isRequired        Boolean          @default(false)
  isUnique          Boolean          @default(false)
  isSearchable      Boolean          @default(false)
  isFilterable      Boolean          @default(false)
  defaultValue      String?
  config            Json             @default("{}")
  validation        Json             @default("[]")
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@unique([tenantId, eventId, participantTypeId, entityType, name])
  @@index([tenantId, eventId])
  @@index([eventId, participantTypeId, sortOrder])
}

// ─── Form Designer Domain ──────────────────────────────

model FormTemplate {
  id                String           @id @default(cuid())
  tenantId          String
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId           String
  event             Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participantTypeId String?
  participantType   ParticipantType? @relation(fields: [participantTypeId], references: [id])
  createdBy         String?
  name              String
  description       String?
  version           Int              @default(1)
  definition        Json             @default("{}")
  isActive          Boolean          @default(true)
  publishedAt       DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  versions FormVersion[]
  surveys  Survey[]

  @@unique([tenantId, eventId, participantTypeId, name])
  @@index([tenantId, eventId])
  @@index([tenantId, eventId, isActive])
}

model FormVersion {
  id             String       @id @default(cuid())
  formTemplateId String
  formTemplate   FormTemplate @relation(fields: [formTemplateId], references: [id], onDelete: Cascade)
  version        Int
  definition     Json
  changeHash     String?
  publishedBy    String?
  publishedAt    DateTime?
  createdAt      DateTime     @default(now())

  @@unique([formTemplateId, version])
  @@index([formTemplateId])
}

model SectionTemplate {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String?
  definition  Json
  isActive    Boolean  @default(true)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

// ─── Settings & Feature Flags Domain ────────────────────

model SystemSetting {
  id        String   @id @default(cuid())
  key       String
  value     String
  type      String   @default("string") // string, number, boolean, json
  category  String // general, auth, email, upload, workflow
  scope     String   @default("global") // global, tenant, event, user
  scopeId   String   @default("") // "" for global, tenantId/eventId/userId for others
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([key, scope, scopeId])
  @@index([key])
  @@index([category])
  @@index([scope, scopeId])
}

model FeatureFlag {
  id                String   @id @default(cuid())
  key               String   @unique
  description       String?
  enabled           Boolean  @default(false)
  enabledForTenants String[] @default([])
  enabledForRoles   String[] @default([])
  enabledForUsers   String[] @default([])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// ─── Audit Domain ───────────────────────────────────────

model AuditLog {
  id          String      @id @default(cuid())
  tenantId    String?
  userId      String?
  action      AuditAction
  entityType  String
  entityId    String?
  description String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())

  @@index([tenantId, action])
  @@index([tenantId, entityType, entityId])
  @@index([createdAt])
}

// ─── Notification Domain ─────────────────────────────────

model Notification {
  id        String    @id @default(cuid())
  userId    String
  tenantId  String
  type      String
  title     String
  message   String
  data      Json?
  read      Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([tenantId])
}

// ─── Step Assignment Domain ──────────────────────────────

model StepAssignment {
  id         String             @id @default(cuid())
  stepId     String
  step       Step               @relation(fields: [stepId], references: [id], onDelete: Cascade)
  userId     String
  user       User               @relation("StepAssignments", fields: [userId], references: [id], onDelete: Cascade)
  strategy   AssignmentStrategy @default(MANUAL)
  isActive   Boolean            @default(true)
  assignedBy String?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  @@unique([stepId, userId])
  @@index([stepId, isActive])
  @@index([userId, isActive])
}

// ─── Auto-Action Rules Domain ────────────────────────────

model AutoActionRule {
  id                  String         @id @default(cuid())
  stepId              String
  step                Step           @relation(fields: [stepId], references: [id], onDelete: Cascade)
  name                String
  description         String?
  conditionExpression Json
  actionType          AutoActionType
  priority            Int            @default(0)
  isActive            Boolean        @default(true)
  createdBy           String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  @@index([stepId, isActive, priority])
}

// ─── Delegation Domain ───────────────────────────────────

model DelegationQuota {
  id              String   @id @default(cuid())
  tenantId        String
  eventId         String
  organizationId  String
  maxParticipants Int
  usedCount       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  invites DelegationInvite[]

  @@unique([tenantId, eventId, organizationId])
  @@index([tenantId, eventId])
}

model DelegationInvite {
  id         String                 @id @default(cuid())
  quotaId    String
  quota      DelegationQuota        @relation(fields: [quotaId], references: [id], onDelete: Cascade)
  email      String
  token      String                 @unique
  status     DelegationInviteStatus @default(PENDING)
  invitedBy  String
  acceptedAt DateTime?
  expiresAt  DateTime
  createdAt  DateTime               @default(now())
  updatedAt  DateTime               @updatedAt

  @@index([quotaId, status])
  @@index([token])
  @@index([email])
}

// ─── Saved Views Domain ──────────────────────────────────

model SavedView {
  id         String   @id @default(cuid())
  tenantId   String
  userId     String?
  name       String
  entityType String
  viewType   ViewType @default(TABLE)
  filters    Json     @default("[]")
  sorts      Json     @default("[]")
  columns    Json     @default("[]")
  config     Json     @default("{}")
  isShared   Boolean  @default(false)
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  owner User? @relation("SavedViews", fields: [userId], references: [id], onDelete: SetNull)

  @@unique([tenantId, userId, name, entityType])
  @@index([tenantId, entityType])
  @@index([userId])
}

// ─── Custom Objects Domain ───────────────────────────────

model CustomObjectDefinition {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  slug        String
  description String?
  icon        String?
  fields      Json     @default("[]")
  isActive    Boolean  @default(true)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  records CustomObjectRecord[]

  @@unique([tenantId, slug])
  @@index([tenantId, isActive])
}

model CustomObjectRecord {
  id           String                 @id @default(cuid())
  definitionId String
  definition   CustomObjectDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  tenantId     String
  data         Json                   @default("{}")
  createdBy    String?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt

  @@index([definitionId, tenantId])
  @@index([tenantId])
}

// ─── Analytics Domain ────────────────────────────────────

model AnalyticsSnapshot {
  id         String   @id @default(cuid())
  tenantId   String
  eventId    String?
  metric     String
  value      Float
  dimensions Json     @default("{}")
  period     String
  timestamp  DateTime
  createdAt  DateTime @default(now())

  @@index([tenantId, metric, period])
  @@index([tenantId, eventId, metric])
  @@index([timestamp])
}

// ─── API & Webhooks Domain (Phase 4) ────────────────────

model ApiKey {
  id               String        @id @default(cuid())
  tenantId         String
  tenant           Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name             String
  description      String?
  keyHash          String        @unique
  keyPrefix        String
  permissions      String[]
  scopes           Json?
  rateLimitTier    RateLimitTier @default(STANDARD)
  rateLimitCustom  Int?
  status           ApiKeyStatus  @default(ACTIVE)
  expiresAt        DateTime?
  lastUsedAt       DateTime?
  lastUsedIp       String?
  usageCount       Int           @default(0)
  allowedIps       String[]
  allowedOrigins   String[]
  rotatedFromId    String?       @unique
  rotatedFrom      ApiKey?       @relation("KeyRotation", fields: [rotatedFromId], references: [id])
  rotatedTo        ApiKey?       @relation("KeyRotation")
  rotationGraceEnd DateTime?
  createdBy        String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  revokedAt        DateTime?

  @@index([tenantId, status])
  @@index([keyHash])
  @@index([keyPrefix])
}

model WebhookSubscription {
  id                    String        @id @default(cuid())
  tenantId              String
  tenant                Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  url                   String
  description           String?
  events                String[]
  secret                String
  status                WebhookStatus @default(ACTIVE)
  version               String        @default("v1")
  maxRetries            Int           @default(5)
  retryBackoffMs        Int[]         @default([1000, 5000, 30000, 300000, 1800000])
  timeoutMs             Int           @default(10000)
  consecutiveFailures   Int           @default(0)
  circuitBreakerOpen    Boolean       @default(false)
  circuitBreakerResetAt DateTime?
  headers               Json?
  metadata              Json?
  createdBy             String
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  deliveries WebhookDelivery[]

  @@index([tenantId, status])
}

model WebhookDelivery {
  id              String              @id @default(cuid())
  tenantId        String
  subscriptionId  String
  subscription    WebhookSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  eventType       String
  eventId         String
  payload         Json
  status          DeliveryStatus      @default(PENDING)
  attempts        Int                 @default(0)
  maxAttempts     Int                 @default(5)
  nextRetryAt     DateTime?
  responseCode    Int?
  responseBody    String?
  responseHeaders Json?
  latencyMs       Int?
  errorMessage    String?
  errorType       String?
  deliveredAt     DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([subscriptionId, status])
  @@index([tenantId, eventType, createdAt])
  @@index([status, nextRetryAt])
  @@index([eventId])
}

// ─── Check-in & Access Control Domain (Phase 4) ─────────

model Checkpoint {
  id        String   @id @default(cuid())
  tenantId  String
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name      String
  location  String?
  type      String
  direction String
  isActive  Boolean  @default(true)
  capacity  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accessLogs AccessLog[]

  @@unique([tenantId, eventId, name])
  @@index([eventId, isActive])
}

model AccessLog {
  id             String       @id @default(cuid())
  checkpointId   String
  checkpoint     Checkpoint   @relation(fields: [checkpointId], references: [id], onDelete: Cascade)
  participantId  String?
  participant    Participant? @relation(fields: [participantId], references: [id])
  scanType       ScanType
  scanResult     ScanResult
  qrPayload      String
  scannedBy      String
  deviceId       String?
  overrideReason String?
  scannedAt      DateTime     @default(now())

  @@index([checkpointId, scannedAt])
  @@index([participantId, scannedAt])
  @@index([scanResult, scannedAt])
}

model VenueOccupancy {
  id           String   @id @default(cuid())
  eventId      String
  event        Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  zoneId       String?
  currentCount Int      @default(0)
  maxCapacity  Int
  lastUpdated  DateTime @default(now())

  @@unique([eventId, zoneId])
}

// ─── Kiosk Domain (Phase 4) ─────────────────────────────

model KioskDevice {
  id            String   @id @default(cuid())
  tenantId      String
  eventId       String
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name          String
  location      String
  isOnline      Boolean  @default(true)
  lastHeartbeat DateTime @default(now())
  language      String   @default("en")
  mode          String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions KioskSession[]

  @@unique([tenantId, eventId, name])
}

model KioskSession {
  id            String      @id @default(cuid())
  kioskDeviceId String
  kioskDevice   KioskDevice @relation(fields: [kioskDeviceId], references: [id], onDelete: Cascade)
  participantId String?
  sessionType   String
  language      String      @default("en")
  startedAt     DateTime    @default(now())
  endedAt       DateTime?
  timedOut      Boolean     @default(false)
  metadata      Json?

  @@index([kioskDeviceId, startedAt])
  @@index([participantId])
}

model QueueTicket {
  id            String      @id @default(cuid())
  tenantId      String
  eventId       String
  event         Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id])
  ticketNumber  String
  counterNumber Int?
  status        QueueStatus @default(WAITING)
  priority      Int         @default(0)
  estimatedWait Int?
  joinedAt      DateTime    @default(now())
  calledAt      DateTime?
  servedAt      DateTime?
  completedAt   DateTime?

  @@unique([tenantId, eventId, ticketNumber])
  @@index([eventId, status, priority])
  @@index([participantId])
}

// ─── Bulk Operations Domain (Phase 4) ───────────────────

model BulkOperation {
  id             String              @id @default(cuid())
  tenantId       String
  eventId        String
  event          Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  type           BulkOperationType
  status         BulkOperationStatus @default(VALIDATING)
  description    String
  filters        Json?
  totalItems     Int                 @default(0)
  processedItems Int                 @default(0)
  successCount   Int                 @default(0)
  failureCount   Int                 @default(0)
  inputFileUrl   String?
  outputFileUrl  String?
  snapshotData   Json?
  undoDeadline   DateTime?
  errorLog       Json?
  startedAt      DateTime?
  completedAt    DateTime?
  rolledBackAt   DateTime?
  createdBy      String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  items BulkOperationItem[]

  @@index([tenantId, eventId, status])
  @@index([tenantId, eventId, type, createdAt])
}

model BulkOperationItem {
  id            String        @id @default(cuid())
  operationId   String
  operation     BulkOperation @relation(fields: [operationId], references: [id], onDelete: Cascade)
  participantId String?
  rowNumber     Int?
  status        String
  inputData     Json?
  previousState Json?
  errorMessage  String?
  processedAt   DateTime?

  @@index([operationId, status])
}

// ─── Duplicate Detection & Blacklist Domain (Phase 4) ───

model DuplicateCandidate {
  id              String          @id @default(cuid())
  tenantId        String
  eventId         String?
  participantAId  String
  participantBId  String
  confidenceScore Float
  matchFields     Json
  status          DuplicateStatus @default(PENDING_REVIEW)
  reviewedBy      String?
  reviewedAt      DateTime?
  reviewNotes     String?
  createdAt       DateTime        @default(now())

  @@unique([participantAId, participantBId])
  @@index([tenantId, eventId, status])
  @@index([confidenceScore])
}

model MergeHistory {
  id                String   @id @default(cuid())
  tenantId          String
  survivingId       String
  mergedId          String
  fieldResolution   Json
  approvalsMigrated Int
  mergedBy          String
  mergedAt          DateTime @default(now())

  @@index([survivingId])
  @@index([mergedId])
}

model Blacklist {
  id             String    @id @default(cuid())
  tenantId       String?
  type           String
  name           String?
  nameVariations String[]
  passportNumber String?
  email          String?
  dateOfBirth    DateTime?
  nationality    String?
  organization   String?
  reason         String
  source         String?
  addedBy        String
  expiresAt      DateTime?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([passportNumber])
  @@index([email])
  @@index([isActive])
  @@index([name])
}

// ─── Waitlist Domain (Phase 4) ──────────────────────────

model WaitlistEntry {
  id                String           @id @default(cuid())
  tenantId          String
  eventId           String
  event             Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participantId     String           @unique
  participant       Participant      @relation(fields: [participantId], references: [id], onDelete: Cascade)
  participantType   String
  priority          WaitlistPriority @default(STANDARD)
  position          Int
  status            WaitlistStatus   @default(ACTIVE)
  registrationData  Json
  promotedAt        DateTime?
  promotionDeadline DateTime?
  expiredAt         DateTime?
  withdrawnAt       DateTime?
  notificationsSent Int              @default(0)
  lastNotifiedAt    DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  promotions WaitlistPromotion[]

  @@unique([eventId, participantId])
  @@index([eventId, participantType, priority, position])
  @@index([eventId, status])
  @@index([status, promotionDeadline])
}

model WaitlistPromotion {
  id              String        @id @default(cuid())
  waitlistEntryId String
  waitlistEntry   WaitlistEntry @relation(fields: [waitlistEntryId], references: [id], onDelete: Cascade)
  triggeredBy     String
  triggerEntityId String?
  promotedBy      String?
  slotAvailableAt DateTime
  promotedAt      DateTime      @default(now())
  confirmedAt     DateTime?
  declinedAt      DateTime?

  @@index([waitlistEntryId])
}

// ─── Communication Hub Domain (Phase 4) ─────────────────

model MessageTemplate {
  id        String         @id @default(cuid())
  tenantId  String
  tenant    Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  subject   String?
  body      String
  channel   MessageChannel
  isSystem  Boolean        @default(false)
  variables String[]
  createdBy String?
  updatedBy String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  broadcasts BroadcastMessage[]

  @@unique([tenantId, name, channel])
  @@index([tenantId])
  @@index([channel])
}

model BroadcastMessage {
  id             String           @id @default(cuid())
  tenantId       String
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId        String?
  event          Event?           @relation(fields: [eventId], references: [id])
  templateId     String?
  template       MessageTemplate? @relation(fields: [templateId], references: [id])
  subject        String?
  body           String
  channel        MessageChannel
  status         BroadcastStatus  @default(DRAFT)
  filters        Json
  recipientCount Int              @default(0)
  sentCount      Int              @default(0)
  failedCount    Int              @default(0)
  deliveredCount Int              @default(0)
  bouncedCount   Int              @default(0)
  isEmergency    Boolean          @default(false)
  priority       Int              @default(5)
  scheduledAt    DateTime?
  sentAt         DateTime?
  completedAt    DateTime?
  createdBy      String?
  cancelledBy    String?
  cancelledAt    DateTime?
  cancelReason   String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  deliveries MessageDelivery[]

  @@index([tenantId])
  @@index([eventId])
  @@index([status])
  @@index([scheduledAt])
}

model MessageDelivery {
  id            String           @id @default(cuid())
  broadcastId   String
  broadcast     BroadcastMessage @relation(fields: [broadcastId], references: [id], onDelete: Cascade)
  participantId String
  participant   Participant      @relation(fields: [participantId], references: [id])
  channel       MessageChannel
  recipient     String
  status        MessageStatus    @default(QUEUED)
  externalId    String?
  sentAt        DateTime?
  deliveredAt   DateTime?
  bouncedAt     DateTime?
  errorMessage  String?
  errorCode     String?
  retryCount    Int              @default(0)
  nextRetryAt   DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@unique([broadcastId, participantId, channel])
  @@index([broadcastId])
  @@index([participantId])
  @@index([status])
}

// ─── Event Cloning Domain (Phase 4) ─────────────────────

model EventSeries {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  editions EventEdition[]

  @@unique([tenantId, name])
}

model EventEdition {
  id            String      @id @default(cuid())
  seriesId      String
  series        EventSeries @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  eventId       String      @unique
  event         Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  editionNumber Int
  year          Int
  hostCountry   String?
  hostCity      String?
  notes         String?
  createdAt     DateTime    @default(now())

  @@unique([seriesId, editionNumber])
  @@index([seriesId, year])
}

model CloneOperation {
  id             String      @id @default(cuid())
  tenantId       String
  sourceEventId  String
  targetEventId  String?
  status         CloneStatus @default(PENDING)
  options        Json
  elementsCopied Json?
  errorLog       String?
  startedAt      DateTime    @default(now())
  completedAt    DateTime?
  createdBy      String

  @@index([tenantId, status])
}

// ─── Parallel Workflow Domain (Phase 4) ─────────────────

model ParallelBranch {
  id            String      @id @default(cuid())
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  forkStepId    String
  branchStepId  String
  branchStep    Step        @relation(fields: [branchStepId], references: [id])
  status        String      @default("PENDING")
  completedAt   DateTime?
  completedBy   String?
  action        String?
  remarks       String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([participantId, forkStepId, branchStepId])
  @@index([participantId, forkStepId])
  @@index([status])
}

// ─── Accommodation Domain (Phase 5) ─────────────────────

model Hotel {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId         String
  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name            String
  address         String
  starRating      Int?
  totalRooms      Int
  contactName     String?
  contactPhone    String?
  distanceToVenue String?
  amenities       String[]
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  roomBlocks RoomBlock[]

  @@unique([tenantId, eventId, name])
  @@index([eventId])
}

model RoomBlock {
  id                String          @id @default(cuid())
  hotelId           String
  hotel             Hotel           @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  participantTypeId String?
  roomType          String
  quantity          Int
  pricePerNight     Float?
  status            RoomBlockStatus @default(AVAILABLE)
  checkInDate       DateTime
  checkOutDate      DateTime
  contactEmail      String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  assignments AccommodationAssignment[]

  @@index([hotelId])
  @@index([status])
}

model AccommodationAssignment {
  id              String                        @id @default(cuid())
  tenantId        String
  tenant          Tenant                        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId         String
  event           Event                         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  roomBlockId     String
  roomBlock       RoomBlock                     @relation(fields: [roomBlockId], references: [id], onDelete: Cascade)
  participantId   String                        @unique
  participant     Participant                   @relation(fields: [participantId], references: [id], onDelete: Cascade)
  roomNumber      String?
  checkInDate     DateTime
  checkOutDate    DateTime
  status          AccommodationAssignmentStatus @default(PENDING)
  specialRequests String?
  notes           String?
  assignedBy      String?
  createdAt       DateTime                      @default(now())
  updatedAt       DateTime                      @updatedAt

  @@index([eventId, status])
  @@index([roomBlockId])
}

// ─── Transportation Domain (Phase 5) ────────────────────

model TransportRoute {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name      String
  stops     Json     @default("[]")
  frequency Int?
  startTime String?
  endTime   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transfers Transfer[]

  @@unique([tenantId, eventId, name])
  @@index([eventId, isActive])
}

model Vehicle {
  id            String      @id @default(cuid())
  tenantId      String
  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId       String
  event         Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  plateNumber   String
  type          VehicleType
  capacity      Int
  assignedTo    String?
  driverName    String?
  driverPhone   String?
  gpsTrackingId String?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  transfers Transfer[]

  @@unique([tenantId, eventId, plateNumber])
  @@index([eventId, isActive])
}

model Transfer {
  id          String          @id @default(cuid())
  tenantId    String
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId     String
  event       Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  routeId     String?
  route       TransportRoute? @relation(fields: [routeId], references: [id])
  vehicleId   String?
  vehicle     Vehicle?        @relation(fields: [vehicleId], references: [id])
  type        TransferType
  origin      String
  destination String
  scheduledAt DateTime
  completedAt DateTime?
  status      TransferStatus  @default(SCHEDULED)
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  passengers TransferPassenger[]

  @@index([eventId, scheduledAt])
  @@index([status])
  @@index([vehicleId])
}

model TransferPassenger {
  id            String      @id @default(cuid())
  transferId    String
  transfer      Transfer    @relation(fields: [transferId], references: [id], onDelete: Cascade)
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  seatNumber    Int?
  boardedAt     DateTime?
  droppedAt     DateTime?
  createdAt     DateTime    @default(now())

  @@unique([transferId, participantId])
  @@index([participantId])
}

// ─── Catering Domain (Phase 5) ──────────────────────────

model MealPlan {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name      String
  date      DateTime @db.Date
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions MealSession[]

  @@unique([tenantId, eventId, name, date])
  @@index([eventId])
}

model MealSession {
  id         String   @id @default(cuid())
  mealPlanId String
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  mealType   MealType
  venue      String
  startTime  DateTime
  endTime    DateTime
  capacity   Int?
  menuNotes  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  vouchers MealVoucher[]

  @@index([mealPlanId, mealType])
}

model MealVoucher {
  id              String          @id @default(cuid())
  tenantId        String
  eventId         String
  mealSessionId   String
  mealSession     MealSession     @relation(fields: [mealSessionId], references: [id], onDelete: Cascade)
  participantId   String
  participant     Participant     @relation(fields: [participantId], references: [id], onDelete: Cascade)
  dietaryCategory DietaryCategory @default(REGULAR)
  qrCode          String          @unique
  isRedeemed      Boolean         @default(false)
  redeemedAt      DateTime?
  redeemedBy      String?
  cancelledReason String?
  issuedAt        DateTime        @default(now())

  @@unique([mealSessionId, participantId])
  @@index([participantId])
  @@index([eventId])
}

// ─── Parking Domain (Phase 5) ───────────────────────────

model ParkingZone {
  id             String   @id @default(cuid())
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId        String
  event          Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name           String
  code           String
  capacity       Int
  occupancy      Int      @default(0)
  latitude       Float?
  longitude      Float?
  color          String?
  accessRules    Json     @default("[]")
  operatingHours Json     @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  permits ParkingPermit[]

  @@unique([tenantId, eventId, code])
  @@index([eventId])
}

model ParkingPermit {
  id            String              @id @default(cuid())
  tenantId      String
  tenant        Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId       String
  event         Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  zoneId        String
  zone          ParkingZone         @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  participantId String?
  participant   Participant?        @relation(fields: [participantId], references: [id])
  permitNumber  String
  vehiclePlate  String?
  status        ParkingPermitStatus @default(ACTIVE)
  validFrom     DateTime
  validUntil    DateTime
  issuedBy      String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@unique([tenantId, eventId, permitNumber])
  @@index([eventId, status])
  @@index([participantId])
  @@index([zoneId])
}

// ─── Venue & Floor Plan Domain (Phase 5) ────────────────

model VenueMap {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId      String
  event        Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name         String
  description  String?
  floorPlanUrl String?
  mapData      Json     @default("{}")
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  rooms VenueRoom[]

  @@unique([tenantId, eventId, name])
  @@index([eventId])
}

model VenueRoom {
  id         String   @id @default(cuid())
  venueMapId String
  venueMap   VenueMap @relation(fields: [venueMapId], references: [id], onDelete: Cascade)
  name       String
  floor      String?
  capacity   Int?
  roomType   String?
  equipment  Json     @default("[]")
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  bookings RoomBooking[]

  @@index([venueMapId])
}

model RoomBooking {
  id           String            @id @default(cuid())
  tenantId     String
  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId      String
  event        Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  roomId       String
  room         VenueRoom         @relation(fields: [roomId], references: [id], onDelete: Cascade)
  title        String
  description  String?
  startTime    DateTime
  endTime      DateTime
  status       RoomBookingStatus @default(TENTATIVE)
  bookedBy     String
  bookedByUser User              @relation("RoomBookingBookedBy", fields: [bookedBy], references: [id])
  setup        Json?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([eventId, startTime, endTime])
  @@index([roomId, startTime])
}

// ─── Protocol — Seating Domain (Phase 5) ────────────────

model SeatingPlan {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId       String
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name          String
  layoutType    String
  layout        Json     @default("{}")
  totalSeats    Int
  assignedSeats Int      @default(0)
  isFinalized   Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  assignments SeatingAssignment[]

  @@unique([tenantId, eventId, name])
  @@index([eventId])
}

model SeatingAssignment {
  id             String          @id @default(cuid())
  seatingPlanId  String
  seatingPlan    SeatingPlan     @relation(fields: [seatingPlanId], references: [id], onDelete: Cascade)
  participantId  String
  participant    Participant     @relation(fields: [participantId], references: [id], onDelete: Cascade)
  seatLabel      String
  tableNumber    Int?
  priority       SeatingPriority
  assignedBy     String
  assignedByUser User            @relation("SeatingAssignedBy", fields: [assignedBy], references: [id])
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@unique([seatingPlanId, seatLabel])
  @@unique([seatingPlanId, participantId])
  @@index([participantId])
}

model SeatingConflict {
  id             String    @id @default(cuid())
  tenantId       String
  eventId        String
  seatingPlanId  String?
  participantAId String
  participantBId String
  conflictType   String
  description    String?
  isResolved     Boolean   @default(false)
  resolvedBy     String?
  resolvedByUser User?     @relation("SeatingConflictResolvedBy", fields: [resolvedBy], references: [id])
  resolvedAt     DateTime?
  createdAt      DateTime  @default(now())

  @@unique([tenantId, eventId, participantAId, participantBId])
  @@index([eventId, isResolved])
}

// ─── Protocol — Bilateral Domain (Phase 5) ──────────────

model BilateralMeeting {
  id              String          @id @default(cuid())
  tenantId        String
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId         String
  event           Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  requesterId     String
  requester       Participant     @relation("BilateralRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  requesteeId     String
  requestee       Participant     @relation("BilateralRequestee", fields: [requesteeId], references: [id], onDelete: Cascade)
  status          BilateralStatus @default(REQUESTED)
  requestedBy     String
  requestedByUser User            @relation("BilateralRequestedBy", fields: [requestedBy], references: [id])
  priority        Int             @default(0)
  notes           String?
  roomId          String?
  scheduledAt     DateTime?
  duration        Int             @default(30)
  confirmedAt     DateTime?
  completedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  slots MeetingSlot[]

  @@unique([tenantId, eventId, requesterId, requesteeId])
  @@index([eventId, status])
  @@index([requesterId])
  @@index([requesteeId])
}

model MeetingSlot {
  id        String            @id @default(cuid())
  tenantId  String
  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId   String
  event     Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  meetingId String?
  meeting   BilateralMeeting? @relation(fields: [meetingId], references: [id])
  roomId    String?
  startTime DateTime
  endTime   DateTime
  isBooked  Boolean           @default(false)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([eventId, startTime])
  @@index([meetingId])
  @@index([isBooked])
}

// ─── Companion Domain (Phase 5) ─────────────────────────

model Companion {
  id                   String        @id @default(cuid())
  tenantId             String
  tenant               Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId              String
  event                Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  primaryParticipantId String
  primaryParticipant   Participant   @relation(fields: [primaryParticipantId], references: [id], onDelete: Cascade)
  firstName            String
  lastName             String
  type                 CompanionType
  email                String?
  phone                String?
  passportNumber       String?
  nationality          String?
  dateOfBirth          DateTime?
  photoUrl             String?
  registrationCode     String        @unique
  badgeTemplateId      String?
  extras               Json          @default("{}")
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  activities CompanionActivity[] @relation("CompanionActivities")

  @@index([eventId, primaryParticipantId])
  @@index([tenantId, eventId])
}

model CompanionActivity {
  id                String     @id @default(cuid())
  tenantId          String
  tenant            Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId           String
  event             Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  companionId       String?
  companion         Companion? @relation("CompanionActivities", fields: [companionId], references: [id])
  name              String
  description       String?
  date              DateTime   @db.Date
  startTime         DateTime
  endTime           DateTime
  location          String
  capacity          Int
  currentSignups    Int        @default(0)
  transportIncluded Boolean    @default(true)
  cost              Float?     @default(0)
  notes             String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@index([eventId, date])
  @@index([companionId])
}

// ─── Gift Protocol Domain (Phase 5) ─────────────────────

model GiftItem {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name        String
  description String?
  category    String
  value       Float?
  currency    String   @default("USD")
  quantity    Int
  allocated   Int      @default(0)
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  deliveries GiftDelivery[]

  @@index([eventId, category])
}

model WelcomePackage {
  id                 String   @id @default(cuid())
  tenantId           String
  tenant             Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId            String
  event              Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name               String
  forParticipantType String?
  contents           Json     @default("[]")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  deliveries GiftDelivery[]

  @@unique([tenantId, eventId, name])
  @@index([eventId])
}

model GiftDelivery {
  id               String             @id @default(cuid())
  tenantId         String
  tenant           Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId          String
  event            Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  giftItemId       String?
  giftItem         GiftItem?          @relation(fields: [giftItemId], references: [id])
  welcomePackageId String?
  welcomePackage   WelcomePackage?    @relation(fields: [welcomePackageId], references: [id])
  participantId    String?
  participant      Participant?       @relation(fields: [participantId], references: [id])
  recipientName    String
  status           GiftDeliveryStatus @default(PENDING)
  deliveredAt      DateTime?
  deliveredBy      String?
  deliveredByUser  User?              @relation("GiftDeliveredBy", fields: [deliveredBy], references: [id])
  deliveryMethod   String?
  notes            String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  @@index([eventId, status])
  @@index([participantId])
  @@index([giftItemId])
}

// ─── Incident Management Domain (Phase 5) ───────────────

model Incident {
  id             String           @id @default(cuid())
  tenantId       String
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId        String
  event          Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  title          String
  description    String
  severity       IncidentSeverity
  status         IncidentStatus   @default(REPORTED)
  location       String?
  reportedBy     String
  reportedByUser User             @relation("IncidentReportedBy", fields: [reportedBy], references: [id])
  assignedTo     String?
  assignedToUser User?            @relation("IncidentAssignedTo", fields: [assignedTo], references: [id])
  resolvedBy     String?
  resolvedByUser User?            @relation("IncidentResolvedBy", fields: [resolvedBy], references: [id])
  resolvedAt     DateTime?
  metadata       Json?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  updates     IncidentUpdate[]
  escalations IncidentEscalation[]

  @@index([eventId, severity, status])
  @@index([status])
  @@index([reportedBy])
  @@index([assignedTo])
}

model IncidentUpdate {
  id            String   @id @default(cuid())
  incidentId    String
  incident      Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  message       String
  updatedBy     String
  updatedByUser User     @relation("IncidentUpdateBy", fields: [updatedBy], references: [id])
  metadata      Json?
  createdAt     DateTime @default(now())

  @@index([incidentId, createdAt])
}

model IncidentEscalation {
  id              String    @id @default(cuid())
  incidentId      String
  incident        Incident  @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  escalatedTo     String
  escalatedToUser User      @relation("EscalatedTo", fields: [escalatedTo], references: [id])
  escalatedBy     String
  escalatedByUser User      @relation("EscalatedBy", fields: [escalatedBy], references: [id])
  reason          String
  acknowledgedAt  DateTime?
  createdAt       DateTime  @default(now())

  @@index([incidentId])
  @@index([escalatedTo])
}

// ─── Command Center Domain (Phase 5) ────────────────────

model CommandCenterWidget {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  widgetType  String
  title       String
  config      Json     @default("{}")
  gridX       Int
  gridY       Int
  gridW       Int
  gridH       Int
  refreshRate Int      @default(5)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([eventId])
}

model AlertRule {
  id              String           @id @default(cuid())
  tenantId        String
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId         String
  event           Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  metric          String
  condition       String
  threshold       Float
  severity        IncidentSeverity @default(MEDIUM)
  cooldownMinutes Int              @default(15)
  isActive        Boolean          @default(true)
  notifyRoles     String[]
  notifyUsers     String[]
  lastTriggered   DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([tenantId, eventId, name])
  @@index([eventId, isActive])
}

// ─── Staff Management Domain (Phase 5) ──────────────────

model StaffMember {
  id        String    @id @default(cuid())
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId   String
  event     Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      StaffRole
  zone      String?
  phone     String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  assignments ShiftAssignment[]

  @@unique([userId, eventId])
  @@index([eventId, role])
  @@index([eventId, isActive])
}

model StaffShift {
  id           String     @id @default(cuid())
  tenantId     String
  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId      String
  event        Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name         String
  date         DateTime   @db.Date
  startTime    DateTime
  endTime      DateTime
  zone         String?
  requiredRole StaffRole?
  capacity     Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  assignments ShiftAssignment[]

  @@index([eventId, date])
}

model ShiftAssignment {
  id             String      @id @default(cuid())
  shiftId        String
  shift          StaffShift  @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  staffMemberId  String
  staffMember    StaffMember @relation(fields: [staffMemberId], references: [id], onDelete: Cascade)
  status         ShiftStatus @default(SCHEDULED)
  checkedInAt    DateTime?
  checkedOutAt   DateTime?
  assignedBy     String
  assignedByUser User        @relation("ShiftAssignedBy", fields: [assignedBy], references: [id])
  notes          String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([shiftId, staffMemberId])
  @@index([staffMemberId])
  @@index([status])
}

// ─── Survey Domain (Phase 5) ────────────────────────────

model Survey {
  id             String        @id @default(cuid())
  tenantId       String
  tenant         Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId        String
  event          Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  formTemplateId String?
  formTemplate   FormTemplate? @relation(fields: [formTemplateId], references: [id])
  title          String
  description    String?
  status         SurveyStatus  @default(DRAFT)
  opensAt        DateTime?
  closesAt       DateTime?
  isAnonymous    Boolean       @default(false)
  createdBy      String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  responses SurveyResponse[]

  @@index([eventId, status])
}

model SurveyResponse {
  id            String       @id @default(cuid())
  surveyId      String
  survey        Survey       @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  participantId String?
  participant   Participant? @relation(fields: [participantId], references: [id])
  answers       Json         @default("{}")
  submittedAt   DateTime     @default(now())

  @@index([surveyId])
  @@index([participantId])
}

// ─── Certificate Domain (Phase 5) ───────────────────────

model CertificateTemplate {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId     String?
  event       Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name        String
  description String?
  layout      Json     @default("{}")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  certificates Certificate[]

  @@index([tenantId])
  @@index([eventId])
}

model Certificate {
  id            String              @id @default(cuid())
  tenantId      String
  tenant        Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId       String
  event         Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  templateId    String
  template      CertificateTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  participantId String
  participant   Participant         @relation(fields: [participantId], references: [id], onDelete: Cascade)
  status        CertificateStatus   @default(DRAFT)
  fileUrl       String?
  qrCode        String?             @unique
  issuedAt      DateTime?
  sentAt        DateTime?
  downloadedAt  DateTime?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@unique([templateId, participantId])
  @@index([eventId, status])
  @@index([participantId])
}

// ─── Compliance Domain (Phase 5) ────────────────────────

model DocumentRequirement {
  id               String   @id @default(cuid())
  tenantId         String
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId          String
  event            Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name             String
  description      String?
  documentType     String
  isRequired       Boolean  @default(true)
  participantTypes String[]
  validityDays     Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  documents ParticipantDocument[]

  @@unique([tenantId, eventId, name])
  @@index([eventId])
}

model ParticipantDocument {
  id             String              @id @default(cuid())
  tenantId       String
  tenant         Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  requirementId  String
  requirement    DocumentRequirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
  participantId  String
  participant    Participant         @relation(fields: [participantId], references: [id], onDelete: Cascade)
  fileName       String
  fileSize       Int
  mimeType       String
  storageUrl     String
  status         ComplianceStatus    @default(NOT_PROVIDED)
  expiresAt      DateTime?
  verifiedAt     DateTime?
  verifiedBy     String?
  verifiedByUser User?               @relation("DocumentVerifiedBy", fields: [verifiedBy], references: [id])
  metadata       Json?
  uploadedAt     DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@unique([requirementId, participantId])
  @@index([participantId])
  @@index([status])
}

model DataRetentionPolicy {
  id            String              @id @default(cuid())
  tenantId      String
  tenant        Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  entityType    String
  retentionDays Int
  action        DataRetentionAction @default(ANONYMIZE)
  isActive      Boolean             @default(true)
  lastRunAt     DateTime?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@unique([tenantId, entityType])
  @@index([isActive])
}
