generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────

enum UserStatus {
  ACTIVE
  INACTIVE
  LOCKED
  SUSPENDED
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELED
  COMPLETED
  POSTPONED
  RESCHEDULED
}

enum FieldDataType {
  TEXT
  LONG_TEXT
  NUMBER
  BOOLEAN
  DATE
  DATETIME
  ENUM
  MULTI_ENUM
  EMAIL
  URL
  PHONE
  FILE
  IMAGE
  REFERENCE
  FORMULA
  JSON
}

enum RequestStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  CANCELLED
  PRINTED
}

enum WorkflowStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum StepType {
  REVIEW
  APPROVAL
  PRINT
  COLLECT
  NOTIFICATION
  CUSTOM
  FORK
  JOIN
}

enum AssignmentStrategy {
  MANUAL
  ROUND_ROBIN
  LEAST_LOADED
}

enum AutoActionType {
  AUTO_APPROVE
  AUTO_REJECT
  AUTO_BYPASS
  AUTO_ESCALATE
}

enum DelegationInviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum ViewType {
  TABLE
  KANBAN
  CALENDAR
  GALLERY
}

enum StepAction {
  APPROVE
  REJECT
  BYPASS
  RETURN
  ESCALATE
}

enum SLAAction {
  NOTIFY
  ESCALATE
  AUTO_APPROVE
  AUTO_REJECT
  REASSIGN
}

enum ApprovalAction {
  APPROVE
  REJECT
  BYPASS
  RETURN
  ESCALATE
  PRINT
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  APPROVE
  REJECT
  PRINT
  COLLECT
  EXPORT
  IMPORT
  CONFIGURE
  ASSIGN
  SLA_BREACH
  RATE_LIMIT
  FILE_UPLOAD
  FILE_UPLOAD_BLOCKED
}

enum ApiKeyStatus {
  ACTIVE
  ROTATED
  REVOKED
  EXPIRED
}

enum RateLimitTier {
  STANDARD
  ELEVATED
  PREMIUM
  CUSTOM
}

enum WebhookStatus {
  ACTIVE
  PAUSED
  DISABLED
  SUSPENDED
}

enum DeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  RETRYING
  DEAD_LETTER
}

enum ScanType {
  QR_SCAN
  NFC_TAP
  MANUAL_ENTRY
}

enum ScanResult {
  VALID
  INVALID
  EXPIRED
  REVOKED
  ALREADY_SCANNED
  MANUAL_OVERRIDE
}

enum BulkOperationType {
  IMPORT_PARTICIPANTS
  EXPORT_PARTICIPANTS
  STATUS_CHANGE
  BULK_APPROVE
  BULK_REJECT
  BULK_BYPASS
  FIELD_UPDATE
  DELETE
}

enum BulkOperationStatus {
  VALIDATING
  PREVIEW
  CONFIRMED
  PROCESSING
  COMPLETED
  FAILED
  ROLLED_BACK
}

enum DuplicateStatus {
  PENDING_REVIEW
  CONFIRMED_DUPLICATE
  NOT_DUPLICATE
  MERGED
}

enum WaitlistStatus {
  ACTIVE
  PROMOTED
  EXPIRED
  WITHDRAWN
  CANCELLED
}

enum WaitlistPriority {
  STANDARD
  HIGH
  VIP
}

enum MessageChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum MessageStatus {
  QUEUED
  SENDING
  SENT
  DELIVERED
  BOUNCED
  FAILED
}

enum BroadcastStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  CANCELLED
}

enum CloneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  ROLLED_BACK
}

enum QueueStatus {
  WAITING
  CALLED
  SERVING
  COMPLETED
  CANCELLED
}

// ─── Identity & Access Domain ────────────────────────────

model Tenant {
  id               String   @id @default(cuid())
  name             String   @unique
  email            String   @unique
  phone            String
  website          String?
  address          String?
  city             String?
  state            String?
  zip              String?
  country          String?
  billingInfo      Json?
  subscriptionPlan String
  featureFlags     Json?
  usageMetrics     Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  users            User[]
  events           Event[]
  roles            Role[]
  participantTypes ParticipantType[]
  workflows        Workflow[]
  participants     Participant[]
  fieldDefinitions FieldDefinition[]
  formTemplates    FormTemplate[]
  sectionTemplates SectionTemplate[]
  notifications    Notification[]

  // Phase 4 reverse relations
  apiKeys              ApiKey[]
  webhookSubscriptions WebhookSubscription[]
  messageTemplates     MessageTemplate[]
  broadcastMessages    BroadcastMessage[]
  eventSeries          EventSeries[]

  @@index([name, email])
}

model User {
  id                  String     @id @default(cuid())
  email               String     @unique
  username            String     @unique
  name                String?
  status              UserStatus @default(ACTIVE)
  failedLoginAttempts Int        @default(0)
  lastFailedLoginAt   DateTime?
  lockedAt            DateTime?
  lockReason          String?
  lockCount           Int        @default(0)
  autoUnlockAt        DateTime?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  deletedAt           DateTime?

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  password        Password?
  sessions        Session[]
  userRoles       UserRole[]
  approvals       Approval[]
  notifications   Notification[]
  stepAssignments StepAssignment[] @relation("StepAssignments")
  savedViews      SavedView[]      @relation("SavedViews")

  @@index([deletedAt])
  @@index([tenantId])
}

model Password {
  hash   String
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Session {
  id             String   @id @default(cuid())
  expirationDate DateTime
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId, expirationDate])
}

// ─── Event Management Domain ─────────────────────────────

model Event {
  id          String      @id @default(cuid())
  name        String
  description String
  tenantId    String
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  status      EventStatus @default(DRAFT)
  startDate   DateTime
  endDate     DateTime
  extras      Json        @default("{}")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?

  participantTypes ParticipantType[]
  participants     Participant[]
  workflows        Workflow[]
  fieldDefinitions FieldDefinition[]
  formTemplates    FormTemplate[]
  userRoles        UserRole[]
  delegationQuotas DelegationQuota[]

  // Phase 4 reverse relations
  checkpoints       Checkpoint[]
  venueOccupancies  VenueOccupancy[]
  kioskDevices      KioskDevice[]
  queueTickets      QueueTicket[]
  bulkOperations    BulkOperation[]
  waitlistEntries   WaitlistEntry[]
  broadcastMessages BroadcastMessage[]
  eventEdition      EventEdition?

  @@unique([tenantId, name])
  @@index([tenantId, status])
  @@index([deletedAt])
}

// ─── RBAC Domain ────────────────────────────────────────

model Role {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Permission {
  id          String   @id @default(cuid())
  resource    String
  action      String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]

  @@unique([resource, action])
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  eventId   String?
  event     Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, roleId, eventId])
  @@index([userId])
  @@index([roleId])
  @@index([eventId])
}

// ─── Participant & Workflow Domain ──────────────────────

model ParticipantType {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name        String
  code        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  participants     Participant[]
  fieldDefinitions FieldDefinition[]
  formTemplates    FormTemplate[]

  @@unique([tenantId, eventId, code])
  @@index([tenantId, eventId])
}

model Workflow {
  id          String         @id @default(cuid())
  tenantId    String
  tenant      Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId     String
  event       Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name        String
  description String?
  status      WorkflowStatus @default(DRAFT)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?

  steps        Step[]
  versions     WorkflowVersion[]
  participants Participant[]

  @@unique([tenantId, eventId, name])
  @@index([tenantId])
  @@index([eventId])
  @@index([deletedAt])
}

model Step {
  id                 String     @id @default(cuid())
  workflowId         String
  workflow           Workflow   @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  name               String
  description        String?
  order              Int
  stepType           StepType   @default(REVIEW)
  isEntryPoint       Boolean    @default(false)
  isTerminal         Boolean    @default(false)
  // Soft references (string IDs) for flexible routing
  nextStepId         String?
  rejectionTargetId  String?
  bypassTargetId     String?
  escalationTargetId String?
  // SLA configuration
  slaDurationMinutes Int?
  slaAction          SLAAction?
  config             Json       @default("{}")
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  approvals       Approval[]
  assignments     StepAssignment[]
  autoActionRules AutoActionRule[]

  // Phase 4 reverse relations
  parallelBranches ParallelBranch[]

  @@unique([workflowId, order])
  @@index([workflowId])
}

model WorkflowVersion {
  id                String   @id @default(cuid())
  workflowId        String
  workflow          Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  version           Int
  snapshot          Json
  changeDescription String?
  createdBy         String
  createdAt         DateTime @default(now())

  participants Participant[]

  @@unique([workflowId, version])
  @@index([workflowId])
}

model Participant {
  id                String           @id @default(cuid())
  tenantId          String
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId           String
  event             Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participantTypeId String
  participantType   ParticipantType  @relation(fields: [participantTypeId], references: [id])
  workflowId        String
  workflow          Workflow         @relation(fields: [workflowId], references: [id])
  workflowVersionId String?
  workflowVersion   WorkflowVersion? @relation(fields: [workflowVersionId], references: [id])
  currentStepId     String?
  // Fixed identity fields
  registrationCode  String
  firstName         String
  lastName          String
  email             String?
  organization      String?
  jobTitle          String?
  nationality       String?
  status            RequestStatus    @default(PENDING)
  // Dynamic fields
  extras            Json             @default("{}")
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  deletedAt         DateTime?

  approvals Approval[]

  // Phase 4 reverse relations
  accessLogs        AccessLog[]
  queueTickets      QueueTicket[]
  waitlistEntry     WaitlistEntry?
  messageDeliveries MessageDelivery[]
  parallelBranches  ParallelBranch[]

  @@unique([tenantId, eventId, registrationCode])
  @@index([tenantId, eventId])
  @@index([eventId, status])
  @@index([participantTypeId])
  @@index([workflowId])
  @@index([workflowVersionId])
  @@index([currentStepId])
  @@index([deletedAt])
}

model Approval {
  id            String         @id @default(cuid())
  participantId String
  participant   Participant    @relation(fields: [participantId], references: [id], onDelete: Cascade)
  stepId        String
  step          Step           @relation(fields: [stepId], references: [id])
  userId        String
  user          User           @relation(fields: [userId], references: [id])
  action        ApprovalAction
  remarks       String?
  metadata      Json?
  createdAt     DateTime       @default(now())

  @@index([participantId, stepId])
  @@index([stepId, userId])
  @@index([userId, createdAt])
}

model FieldDefinition {
  id                String           @id @default(cuid())
  tenantId          String
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId           String
  event             Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participantTypeId String?
  participantType   ParticipantType? @relation(fields: [participantTypeId], references: [id])
  entityType        String           @default("Participant")
  name              String
  label             String
  description       String?
  dataType          FieldDataType
  sortOrder         Int              @default(0)
  isRequired        Boolean          @default(false)
  isUnique          Boolean          @default(false)
  isSearchable      Boolean          @default(false)
  isFilterable      Boolean          @default(false)
  defaultValue      String?
  config            Json             @default("{}")
  validation        Json             @default("[]")
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@unique([tenantId, eventId, participantTypeId, entityType, name])
  @@index([tenantId, eventId])
  @@index([eventId, participantTypeId, sortOrder])
}

// ─── Form Designer Domain ──────────────────────────────

model FormTemplate {
  id                String           @id @default(cuid())
  tenantId          String
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId           String
  event             Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participantTypeId String?
  participantType   ParticipantType? @relation(fields: [participantTypeId], references: [id])
  createdBy         String?
  name              String
  description       String?
  version           Int              @default(1)
  definition        Json             @default("{}")
  isActive          Boolean          @default(true)
  publishedAt       DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  versions FormVersion[]

  @@unique([tenantId, eventId, participantTypeId, name])
  @@index([tenantId, eventId])
  @@index([tenantId, eventId, isActive])
}

model FormVersion {
  id             String       @id @default(cuid())
  formTemplateId String
  formTemplate   FormTemplate @relation(fields: [formTemplateId], references: [id], onDelete: Cascade)
  version        Int
  definition     Json
  changeHash     String?
  publishedBy    String?
  publishedAt    DateTime?
  createdAt      DateTime     @default(now())

  @@unique([formTemplateId, version])
  @@index([formTemplateId])
}

model SectionTemplate {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String?
  definition  Json
  isActive    Boolean  @default(true)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

// ─── Settings & Feature Flags Domain ────────────────────

model SystemSetting {
  id        String   @id @default(cuid())
  key       String
  value     String
  type      String   @default("string") // string, number, boolean, json
  category  String // general, auth, email, upload, workflow
  scope     String   @default("global") // global, tenant, event, user
  scopeId   String   @default("") // "" for global, tenantId/eventId/userId for others
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([key, scope, scopeId])
  @@index([key])
  @@index([category])
  @@index([scope, scopeId])
}

model FeatureFlag {
  id                String   @id @default(cuid())
  key               String   @unique
  description       String?
  enabled           Boolean  @default(false)
  enabledForTenants String[] @default([])
  enabledForRoles   String[] @default([])
  enabledForUsers   String[] @default([])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// ─── Audit Domain ───────────────────────────────────────

model AuditLog {
  id          String      @id @default(cuid())
  tenantId    String?
  userId      String?
  action      AuditAction
  entityType  String
  entityId    String?
  description String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())

  @@index([tenantId, action])
  @@index([tenantId, entityType, entityId])
  @@index([createdAt])
}

// ─── Notification Domain ─────────────────────────────────

model Notification {
  id        String    @id @default(cuid())
  userId    String
  tenantId  String
  type      String
  title     String
  message   String
  data      Json?
  read      Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([tenantId])
}

// ─── Step Assignment Domain ──────────────────────────────

model StepAssignment {
  id         String             @id @default(cuid())
  stepId     String
  step       Step               @relation(fields: [stepId], references: [id], onDelete: Cascade)
  userId     String
  user       User               @relation("StepAssignments", fields: [userId], references: [id], onDelete: Cascade)
  strategy   AssignmentStrategy @default(MANUAL)
  isActive   Boolean            @default(true)
  assignedBy String?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  @@unique([stepId, userId])
  @@index([stepId, isActive])
  @@index([userId, isActive])
}

// ─── Auto-Action Rules Domain ────────────────────────────

model AutoActionRule {
  id                  String         @id @default(cuid())
  stepId              String
  step                Step           @relation(fields: [stepId], references: [id], onDelete: Cascade)
  name                String
  description         String?
  conditionExpression Json
  actionType          AutoActionType
  priority            Int            @default(0)
  isActive            Boolean        @default(true)
  createdBy           String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  @@index([stepId, isActive, priority])
}

// ─── Delegation Domain ───────────────────────────────────

model DelegationQuota {
  id              String   @id @default(cuid())
  tenantId        String
  eventId         String
  organizationId  String
  maxParticipants Int
  usedCount       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  invites DelegationInvite[]

  @@unique([tenantId, eventId, organizationId])
  @@index([tenantId, eventId])
}

model DelegationInvite {
  id         String                 @id @default(cuid())
  quotaId    String
  quota      DelegationQuota        @relation(fields: [quotaId], references: [id], onDelete: Cascade)
  email      String
  token      String                 @unique
  status     DelegationInviteStatus @default(PENDING)
  invitedBy  String
  acceptedAt DateTime?
  expiresAt  DateTime
  createdAt  DateTime               @default(now())
  updatedAt  DateTime               @updatedAt

  @@index([quotaId, status])
  @@index([token])
  @@index([email])
}

// ─── Saved Views Domain ──────────────────────────────────

model SavedView {
  id         String   @id @default(cuid())
  tenantId   String
  userId     String?
  name       String
  entityType String
  viewType   ViewType @default(TABLE)
  filters    Json     @default("[]")
  sorts      Json     @default("[]")
  columns    Json     @default("[]")
  config     Json     @default("{}")
  isShared   Boolean  @default(false)
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  owner User? @relation("SavedViews", fields: [userId], references: [id], onDelete: SetNull)

  @@unique([tenantId, userId, name, entityType])
  @@index([tenantId, entityType])
  @@index([userId])
}

// ─── Custom Objects Domain ───────────────────────────────

model CustomObjectDefinition {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  slug        String
  description String?
  icon        String?
  fields      Json     @default("[]")
  isActive    Boolean  @default(true)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  records CustomObjectRecord[]

  @@unique([tenantId, slug])
  @@index([tenantId, isActive])
}

model CustomObjectRecord {
  id           String                 @id @default(cuid())
  definitionId String
  definition   CustomObjectDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  tenantId     String
  data         Json                   @default("{}")
  createdBy    String?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt

  @@index([definitionId, tenantId])
  @@index([tenantId])
}

// ─── Analytics Domain ────────────────────────────────────

model AnalyticsSnapshot {
  id         String   @id @default(cuid())
  tenantId   String
  eventId    String?
  metric     String
  value      Float
  dimensions Json     @default("{}")
  period     String
  timestamp  DateTime
  createdAt  DateTime @default(now())

  @@index([tenantId, metric, period])
  @@index([tenantId, eventId, metric])
  @@index([timestamp])
}

// ─── API & Webhooks Domain (Phase 4) ────────────────────

model ApiKey {
  id               String        @id @default(cuid())
  tenantId         String
  tenant           Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name             String
  description      String?
  keyHash          String        @unique
  keyPrefix        String
  permissions      String[]
  scopes           Json?
  rateLimitTier    RateLimitTier @default(STANDARD)
  rateLimitCustom  Int?
  status           ApiKeyStatus  @default(ACTIVE)
  expiresAt        DateTime?
  lastUsedAt       DateTime?
  lastUsedIp       String?
  usageCount       Int           @default(0)
  allowedIps       String[]
  allowedOrigins   String[]
  rotatedFromId    String?       @unique
  rotatedFrom      ApiKey?       @relation("KeyRotation", fields: [rotatedFromId], references: [id])
  rotatedTo        ApiKey?       @relation("KeyRotation")
  rotationGraceEnd DateTime?
  createdBy        String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  revokedAt        DateTime?

  @@index([tenantId, status])
  @@index([keyHash])
  @@index([keyPrefix])
}

model WebhookSubscription {
  id                    String        @id @default(cuid())
  tenantId              String
  tenant                Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  url                   String
  description           String?
  events                String[]
  secret                String
  status                WebhookStatus @default(ACTIVE)
  version               String        @default("v1")
  maxRetries            Int           @default(5)
  retryBackoffMs        Int[]         @default([1000, 5000, 30000, 300000, 1800000])
  timeoutMs             Int           @default(10000)
  consecutiveFailures   Int           @default(0)
  circuitBreakerOpen    Boolean       @default(false)
  circuitBreakerResetAt DateTime?
  headers               Json?
  metadata              Json?
  createdBy             String
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  deliveries WebhookDelivery[]

  @@index([tenantId, status])
}

model WebhookDelivery {
  id              String              @id @default(cuid())
  tenantId        String
  subscriptionId  String
  subscription    WebhookSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  eventType       String
  eventId         String
  payload         Json
  status          DeliveryStatus      @default(PENDING)
  attempts        Int                 @default(0)
  maxAttempts     Int                 @default(5)
  nextRetryAt     DateTime?
  responseCode    Int?
  responseBody    String?
  responseHeaders Json?
  latencyMs       Int?
  errorMessage    String?
  errorType       String?
  deliveredAt     DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([subscriptionId, status])
  @@index([tenantId, eventType, createdAt])
  @@index([status, nextRetryAt])
  @@index([eventId])
}

// ─── Check-in & Access Control Domain (Phase 4) ─────────

model Checkpoint {
  id        String   @id @default(cuid())
  tenantId  String
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name      String
  location  String?
  type      String
  direction String
  isActive  Boolean  @default(true)
  capacity  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accessLogs AccessLog[]

  @@unique([tenantId, eventId, name])
  @@index([eventId, isActive])
}

model AccessLog {
  id             String       @id @default(cuid())
  checkpointId   String
  checkpoint     Checkpoint   @relation(fields: [checkpointId], references: [id], onDelete: Cascade)
  participantId  String?
  participant    Participant? @relation(fields: [participantId], references: [id])
  scanType       ScanType
  scanResult     ScanResult
  qrPayload      String
  scannedBy      String
  deviceId       String?
  overrideReason String?
  scannedAt      DateTime     @default(now())

  @@index([checkpointId, scannedAt])
  @@index([participantId, scannedAt])
  @@index([scanResult, scannedAt])
}

model VenueOccupancy {
  id           String   @id @default(cuid())
  eventId      String
  event        Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  zoneId       String?
  currentCount Int      @default(0)
  maxCapacity  Int
  lastUpdated  DateTime @default(now())

  @@unique([eventId, zoneId])
}

// ─── Kiosk Domain (Phase 4) ─────────────────────────────

model KioskDevice {
  id            String   @id @default(cuid())
  tenantId      String
  eventId       String
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name          String
  location      String
  isOnline      Boolean  @default(true)
  lastHeartbeat DateTime @default(now())
  language      String   @default("en")
  mode          String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions KioskSession[]

  @@unique([tenantId, eventId, name])
}

model KioskSession {
  id            String      @id @default(cuid())
  kioskDeviceId String
  kioskDevice   KioskDevice @relation(fields: [kioskDeviceId], references: [id], onDelete: Cascade)
  participantId String?
  sessionType   String
  language      String      @default("en")
  startedAt     DateTime    @default(now())
  endedAt       DateTime?
  timedOut      Boolean     @default(false)
  metadata      Json?

  @@index([kioskDeviceId, startedAt])
  @@index([participantId])
}

model QueueTicket {
  id            String      @id @default(cuid())
  tenantId      String
  eventId       String
  event         Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id])
  ticketNumber  String
  counterNumber Int?
  status        QueueStatus @default(WAITING)
  priority      Int         @default(0)
  estimatedWait Int?
  joinedAt      DateTime    @default(now())
  calledAt      DateTime?
  servedAt      DateTime?
  completedAt   DateTime?

  @@unique([tenantId, eventId, ticketNumber])
  @@index([eventId, status, priority])
  @@index([participantId])
}

// ─── Bulk Operations Domain (Phase 4) ───────────────────

model BulkOperation {
  id             String              @id @default(cuid())
  tenantId       String
  eventId        String
  event          Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  type           BulkOperationType
  status         BulkOperationStatus @default(VALIDATING)
  description    String
  filters        Json?
  totalItems     Int                 @default(0)
  processedItems Int                 @default(0)
  successCount   Int                 @default(0)
  failureCount   Int                 @default(0)
  inputFileUrl   String?
  outputFileUrl  String?
  snapshotData   Json?
  undoDeadline   DateTime?
  errorLog       Json?
  startedAt      DateTime?
  completedAt    DateTime?
  rolledBackAt   DateTime?
  createdBy      String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  items BulkOperationItem[]

  @@index([tenantId, eventId, status])
  @@index([tenantId, eventId, type, createdAt])
}

model BulkOperationItem {
  id            String        @id @default(cuid())
  operationId   String
  operation     BulkOperation @relation(fields: [operationId], references: [id], onDelete: Cascade)
  participantId String?
  rowNumber     Int?
  status        String
  inputData     Json?
  previousState Json?
  errorMessage  String?
  processedAt   DateTime?

  @@index([operationId, status])
}

// ─── Duplicate Detection & Blacklist Domain (Phase 4) ───

model DuplicateCandidate {
  id              String          @id @default(cuid())
  tenantId        String
  eventId         String?
  participantAId  String
  participantBId  String
  confidenceScore Float
  matchFields     Json
  status          DuplicateStatus @default(PENDING_REVIEW)
  reviewedBy      String?
  reviewedAt      DateTime?
  reviewNotes     String?
  createdAt       DateTime        @default(now())

  @@unique([participantAId, participantBId])
  @@index([tenantId, eventId, status])
  @@index([confidenceScore])
}

model MergeHistory {
  id                String   @id @default(cuid())
  tenantId          String
  survivingId       String
  mergedId          String
  fieldResolution   Json
  approvalsMigrated Int
  mergedBy          String
  mergedAt          DateTime @default(now())

  @@index([survivingId])
  @@index([mergedId])
}

model Blacklist {
  id             String    @id @default(cuid())
  tenantId       String?
  type           String
  name           String?
  nameVariations String[]
  passportNumber String?
  email          String?
  dateOfBirth    DateTime?
  nationality    String?
  organization   String?
  reason         String
  source         String?
  addedBy        String
  expiresAt      DateTime?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([passportNumber])
  @@index([email])
  @@index([isActive])
  @@index([name])
}

// ─── Waitlist Domain (Phase 4) ──────────────────────────

model WaitlistEntry {
  id                String           @id @default(cuid())
  tenantId          String
  eventId           String
  event             Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participantId     String           @unique
  participant       Participant      @relation(fields: [participantId], references: [id], onDelete: Cascade)
  participantType   String
  priority          WaitlistPriority @default(STANDARD)
  position          Int
  status            WaitlistStatus   @default(ACTIVE)
  registrationData  Json
  promotedAt        DateTime?
  promotionDeadline DateTime?
  expiredAt         DateTime?
  withdrawnAt       DateTime?
  notificationsSent Int              @default(0)
  lastNotifiedAt    DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  promotions WaitlistPromotion[]

  @@unique([eventId, participantId])
  @@index([eventId, participantType, priority, position])
  @@index([eventId, status])
  @@index([status, promotionDeadline])
}

model WaitlistPromotion {
  id              String        @id @default(cuid())
  waitlistEntryId String
  waitlistEntry   WaitlistEntry @relation(fields: [waitlistEntryId], references: [id], onDelete: Cascade)
  triggeredBy     String
  triggerEntityId String?
  promotedBy      String?
  slotAvailableAt DateTime
  promotedAt      DateTime      @default(now())
  confirmedAt     DateTime?
  declinedAt      DateTime?

  @@index([waitlistEntryId])
}

// ─── Communication Hub Domain (Phase 4) ─────────────────

model MessageTemplate {
  id        String         @id @default(cuid())
  tenantId  String
  tenant    Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  subject   String?
  body      String
  channel   MessageChannel
  isSystem  Boolean        @default(false)
  variables String[]
  createdBy String?
  updatedBy String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  broadcasts BroadcastMessage[]

  @@unique([tenantId, name, channel])
  @@index([tenantId])
  @@index([channel])
}

model BroadcastMessage {
  id             String           @id @default(cuid())
  tenantId       String
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventId        String?
  event          Event?           @relation(fields: [eventId], references: [id])
  templateId     String?
  template       MessageTemplate? @relation(fields: [templateId], references: [id])
  subject        String?
  body           String
  channel        MessageChannel
  status         BroadcastStatus  @default(DRAFT)
  filters        Json
  recipientCount Int              @default(0)
  sentCount      Int              @default(0)
  failedCount    Int              @default(0)
  deliveredCount Int              @default(0)
  bouncedCount   Int              @default(0)
  isEmergency    Boolean          @default(false)
  priority       Int              @default(5)
  scheduledAt    DateTime?
  sentAt         DateTime?
  completedAt    DateTime?
  createdBy      String?
  cancelledBy    String?
  cancelledAt    DateTime?
  cancelReason   String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  deliveries MessageDelivery[]

  @@index([tenantId])
  @@index([eventId])
  @@index([status])
  @@index([scheduledAt])
}

model MessageDelivery {
  id            String           @id @default(cuid())
  broadcastId   String
  broadcast     BroadcastMessage @relation(fields: [broadcastId], references: [id], onDelete: Cascade)
  participantId String
  participant   Participant      @relation(fields: [participantId], references: [id])
  channel       MessageChannel
  recipient     String
  status        MessageStatus    @default(QUEUED)
  externalId    String?
  sentAt        DateTime?
  deliveredAt   DateTime?
  bouncedAt     DateTime?
  errorMessage  String?
  errorCode     String?
  retryCount    Int              @default(0)
  nextRetryAt   DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@unique([broadcastId, participantId, channel])
  @@index([broadcastId])
  @@index([participantId])
  @@index([status])
}

// ─── Event Cloning Domain (Phase 4) ─────────────────────

model EventSeries {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  editions EventEdition[]

  @@unique([tenantId, name])
}

model EventEdition {
  id            String      @id @default(cuid())
  seriesId      String
  series        EventSeries @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  eventId       String      @unique
  event         Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  editionNumber Int
  year          Int
  hostCountry   String?
  hostCity      String?
  notes         String?
  createdAt     DateTime    @default(now())

  @@unique([seriesId, editionNumber])
  @@index([seriesId, year])
}

model CloneOperation {
  id             String      @id @default(cuid())
  tenantId       String
  sourceEventId  String
  targetEventId  String?
  status         CloneStatus @default(PENDING)
  options        Json
  elementsCopied Json?
  errorLog       String?
  startedAt      DateTime    @default(now())
  completedAt    DateTime?
  createdBy      String

  @@index([tenantId, status])
}

// ─── Parallel Workflow Domain (Phase 4) ─────────────────

model ParallelBranch {
  id            String      @id @default(cuid())
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  forkStepId    String
  branchStepId  String
  branchStep    Step        @relation(fields: [branchStepId], references: [id])
  status        String      @default("PENDING")
  completedAt   DateTime?
  completedBy   String?
  action        String?
  remarks       String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([participantId, forkStepId, branchStepId])
  @@index([participantId, forkStepId])
  @@index([status])
}
